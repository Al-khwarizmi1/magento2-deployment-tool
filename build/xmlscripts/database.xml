<?xml version="1.0" encoding="UTF-8"?>

<project name="Database" basedir=".">

    <target name="database:backup:create"
            depends="util:live:dir:properties"
            unless="skipDatabaseBackup"
            hidden="true">
        <if>
            <istrue value="${live.magento.dir.exists}"/>
            <then>
                <basename file="${live.dir}" property="live.dir.basename"/>
                <exec command="echo ${live.dir.basename} | tr . -" outputProperty="live.dir.basename" checkreturn="true"/>

                <property name="database.dump.filename" value="${application.startdir}/${backup.dir}/backup_${live.dir.basename}_${release.timestamp}.sql.gz"/>
                <property name="command.database.dump" value="${bin.n98-magerun2} --root-dir=${live.dir}/${magento.dir} db:dump --compression='gzip' ${database.dump.filename}"/>
                <echo message="${command.database.dump}"/>
                <exec command="${command.database.dump}" outputProperty="command.database.dump.output"
                      checkreturn="true" logoutput="false" />
                <phingcall target="util:check:output">
                    <property name="check.output" value="${command.database.dump.output}" override="true" />
                </phingcall>
            </then>
            <else>
                <echo message="Database dump skipped. Live magento dir not found."/>
            </else>
        </if>
    </target>

</project>